ARG FLINK_VERSION
ARG DINKY_VERSION

FROM flink:${FLINK_VERSION}-scala_2.12-java11 as flink-base


FROM eclipse-temurin:11-jdk-jammy

ARG FLINK_VERSION
ENV FLINK_VERSION=${FLINK_VERSION}
ENV DINKY_HOME=/opt/dinky/
ENV H2_DB=./tmp/db/h2

WORKDIR /opt

USER root
RUN apt-get update \
    && DEBIAN_FRONTEND="noninteractive" apt-get install -y --no-install-recommends \
        net-tools \
        telnetd \
        unzip \
        && apt remove snapd -y \
        && rm -rf /var/lib/apt/lists/* \
        && apt-get clean; apt-get autoremove -y; apt-get autoclean

ADD ../../build/dinky-release-1.18-1.1.0.tar.gz /opt
RUN mv dinky-release-1.18-1.1.0 dinky
RUN  cd /opt/dinky/lib && wget https://repo1.maven.org/maven2/com/mysql/mysql-connector-j/8.2.0/mysql-connector-j-8.2.0.jar

COPY --from=flink-base  /opt/flink/lib/*.jar  /opt/dinky/extends/flink${FLINK_VERSION}/flink/
RUN rm -f  /opt/dinky/extends/flink${FLINK_VERSION}/flink/flink-table-planner-loader*.jar

COPY --from=flink-base  /opt/flink/opt/flink-table-planner*.jar /opt/dinky/extends/flink${FLINK_VERSION}/flink/

RUN mkdir /opt/dinky/customJar && chmod -R 777 /opt/dinky/

EXPOSE 8888
WORKDIR /opt/dinky

CMD  ./auto.sh startOnPending 1.18